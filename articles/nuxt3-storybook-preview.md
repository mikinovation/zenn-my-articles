---
title: "Nuxt3でStorybook生活を送りたい(preview版)"
emoji: "😜"
type: "tech"
topics: ["Prisma"]
published: false
---

:::message
2023年1月26日現在Nuxt3のAuto ImportとStorybookの組み合わせには辛いところがあります(詳細は本文)
よって本記事はプレビュー版として書いておりますが、快適に使えるようになり次第正式版として記事を更新したいです
:::

# はじめに

中長期的なプロジェクトにおいてStorybookは非常に便利なツールとして知られている。Storybookを導入することで様々なメリットがあるからだ

- コンポーネントのドキュメント(UIライブラリ)としての機能
- エンジニアとデザイナーのコミュニケーションツール
- コンポーネントのテストツール

まず一つ目にコンポーネントのドキュメント、仕様書として機能する。これはアプリケーションの中にどのようなコンポーネントがあるのか、どのようなpropsを持っているのか、そのUIはどのように振る舞うことができるのか等をライブラリとして一覧で確認することができる。

次にエンジニアとデザイナーのコミュニケーションツールとしての機能だ。先程のUIライブラリとしての機能を活かして、あるコンポーネントにどのようなpropsのパターンがあるのか。あるpropともう一つのpropの組み合わせに応じてどのようにUIが変化するべきなのか、そういった認識合わせをするためのツールとして活用している方々もいるかもしれない

最後にコンポーネントのテストツールとしての機能だ。特にUIの単体テスト、インタラクションテストを行うためのツールとして活用しているケースもあるだろう

Storybookを導入することにより、快適な開発環境を構築することができるようになるのだ。。。と言いたいところではあるのだが、Nuxt3にはまだまだ改善の余地があると思っている

# Nuxt3とStorybookの活用に立ちはだかる障壁

Nuxt3とStorybookを組み合わせることが難しいと思う理由はただ一つだ

**Nuxt3のAuto ImportがStorybookの活用を妨げてしまっている**という点である

試しに簡単なコンポーネントを書いて、それをStorybookに載せてみよう

まずはNuxt3の機能は使わずにVue3のみの機能でコンポーネントを書いてみる

# 解決方法を考える

## 1. Nuxt3のAuto Importを使わない

- Viteにエイリアスの設定
- @や~等、表記ブレを減らせる

## 2. インラインでcomposableをモックする

- 結論から言うと現時点ではできない

## 3. Container/Presenterパターンで実装する

- 実際の実装に使うコンテナと、Storybookで使うモックコンテナを分けて実装する
- 型を正しくつけることで、実装とモックのブレが出ないように注意する
- Storybookでテストするのは、Presenterのみと割り切る。Storybookでテストができない部分ははplaywriteやCypressといったE2Eテストツールで補完するようにシナリオテストを行おう
- Nuxt3に依存するAPIはコンテナ内からpropsリレーにする
- propsリレーは悪くない。大抵の場合悪いのは自分のコンポーネント設計だ。もし渡すコンポーネントが深くネストしているのであれば、まずはコンポーネントの設計が間違っていないかを考えるべき。
不要なコンポーネント化をしていないか。例えばAtomic DesignのOrganismsでそれはコンポーネントに切り出さず、テンプレートに含んで良かったのではないか。新規作成画面と編集画面の二箇所であればたまたま似ているだけなのに、ロジックが肥大化しているので、コピペしたほうが結果的に管理しやすいのではなかったのか等を考えるべきである
とにかく小さくコンポーネントを切り分けるのが必ずしも正解とは限らない。これがソフトウェアの設計の難しさだ
- コンポーネントも関数もcomposablesも、可能な限り純粋な関数にする。関数型プログラミングと同じ。関数の純粋さについては日本人であれば義務教育で習うはずだ。しかしJavascriptでの実装において関数の純粋性は簡単に崩れ去る。Nuxt3に依存しないように作ることで、テスト容易性を保つ
- useAsyncDataのモック関数を作る

## まとめ

正直VueやNuxtの思想とは正反対のことをやって、もがいている感がある。人によってはそれなら初めからReact使えばいいと考えられる方もいるかしれない
それでも私はまだまだNuxtにポテンシャルがあると思っているので、プロジェクトに応じて使っていきたい